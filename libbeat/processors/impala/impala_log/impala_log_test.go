// Licensed to Elasticsearch B.V. under one or more contributor
// license agreements. See the NOTICE file distributed with
// this work for additional information regarding copyright
// ownership. Elasticsearch B.V. licenses this file to you under
// the Apache License, Version 2.0 (the "License"); you may
// not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

package impala_log_parse

import (
	"fmt"
	"github.com/elastic/beats/v7/libbeat/processors/impala"
	"strconv"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"

	"github.com/elastic/beats/v7/libbeat/beat"
	conf "github.com/elastic/elastic-agent-libs/config"
	"github.com/elastic/elastic-agent-libs/mapstr"
)

// mustParseTime will parse value into a time.Time using the provided layout. If value
// cannot be parsed, this function will panic. If layout does not specify a time zone,
// then a time.Location should be provided by loc. If layout does specify a time zone,
// then loc should be nil. Layouts that do not specify a year will be enriched with
// the current year relative to the location specified for the parsed timestamp.
func mustParseTime(layout, value string, loc *time.Location) time.Time {
	var t time.Time
	var err error

	if loc != nil {
		t, err = time.ParseInLocation(layout, value, loc)
	} else {
		t, err = time.Parse(layout, value)
	}
	if err != nil {
		panic(err)
	}

	// Timestamps that do not include a year will be enriched using the
	// current year relative to the location specified for the timestamp.
	if t.Year() == 0 {
		t = t.AddDate(time.Now().In(t.Location()).Year(), 0, 0)
	}

	return t
}

const (
	rawLine = "I0828 10:36:22.172153 25339 statestore.cc:282] Subscriber 'impalad@e2de5bdh002:6001' registered (registration id: c24233er53agg:c89gg6fds880)"
	profile = "TRuntimeProfileTree({Nodes:[TRuntimeProfileNode({Name:Query (id=4c4d52afea4a40a1:802034563d1cfc93) NumChildren:3 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Summary NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[Connected User: Coordinator:denatb31bda01.test.tiaa-cref.org:22000 Default Db:default Delegated User: End Time:2016-03-29 13:47:44.579234000 Estimated Per-Host Mem:362807296 Estimated Per-Host VCores:2 ExecSummary:\nOperator       #Hosts   Avg Time   Max Time  #Rows  Est. #Rows  Peak Mem  Est. Peak Mem  Detail                \n---------------------------------------------------------------------------------------------------------------\n06:AGGREGATE        1  130.837ms  130.837ms      1           0  16.00 KB        -1.00 B  FINALIZE              \n05:EXCHANGE         1    8.250us    8.250us      1           0         0        -1.00 B  UNPARTITIONED         \n02:AGGREGATE        1  157.644ms  157.644ms      1           0  12.00 KB       10.00 MB                        \n04:AGGREGATE        1    2.452ms    2.452ms      0           0   3.13 MB       10.00 MB                        \n03:EXCHANGE         1    4.584us    4.584us      0           0         0              0  HASH(SSN)             \n01:AGGREGATE        1  159.257ms  159.257ms      0           0   9.45 MB       10.00 MB                        \n00:SCAN HDFS        1   92.478ms   92.478ms      0           0   9.05 MB      336.00 MB  planfocus.enrollments  HiveServer2 Protocol Version:V6 Impala Version:impalad version 2.2.0-cdh5 RELEASE (build 2ffd73a4255cefd521362ffe1cfb37463f67f75c) Network Address:10.233.42.16:42229 Plan:\n----------------\nEstimated Per-Host Requirements: Memory=346.00MB VCores=2\n\nF02:PLAN FRAGMENT [UNPARTITIONED]\n  06:AGGREGATE [FINALIZE]\n  |  output: count:merge(SSN)\n  |  hosts=1 per-host-mem=unavailable\n  |  tuple-ids=2 row-size=8B cardinality=0\n  |\n  05:EXCHANGE [UNPARTITIONED]\n     hosts=1 per-host-mem=unavailable\n     tuple-ids=2 row-size=8B cardinality=0\n\nF01:PLAN FRAGMENT [HASH(SSN)]\n  DATASTREAM SINK [FRAGMENT=F02, EXCHANGE=05, UNPARTITIONED]\n  02:AGGREGATE\n  |  output: count(SSN)\n  |  hosts=1 per-host-mem=10.00MB\n  |  tuple-ids=2 row-size=8B cardinality=0\n  |\n  04:AGGREGATE\n  |  group by: SSN\n  |  hosts=1 per-host-mem=10.00MB\n  |  tuple-ids=1 row-size=25B cardinality=0\n  |\n  03:EXCHANGE [HASH(SSN)]\n     hosts=1 per-host-mem=0B\n     tuple-ids=1 row-size=25B cardinality=0\n\nF00:PLAN FRAGMENT [RANDOM]\n  DATASTREAM SINK [FRAGMENT=F01, EXCHANGE=03, HASH(SSN)]\n  01:AGGREGATE\n  |  group by: SSN\n  |  hosts=1 per-host-mem=10.00MB\n  |  tuple-ids=1 row-size=25B cardinality=0\n  |\n  00:SCAN HDFS [planfocus.enrollments, RANDOM]\n     partitions=1/4 files=1 size=40.23MB\n     predicates: (PLAN_NUMBER IN ('100320', '100321', '100322', '100323', '100325', '100326', '100327')), CLIENT_NUMBER = '008353', PLAN_LEVEL_ENROLLMENT_STATUS = 'Completed Enrollment', ENROLLMENT_TYPE_NAME IN ('Online', 'Paper', 'Phone'), ENROLLMENT_DATE >= '20160312', ENROLLMENT_DATE <= '20160318', SSN NOT IN ('777777777', '999999999')\n     table stats: 1703572 rows total\n     column stats: all\n     hosts=1 per-host-mem=336.00MB\n     tuple-ids=0 row-size=151B cardinality=0\n---------------- Query State:FINISHED Query Status:OK Query Type:QUERY Request Pool:default-pool Session ID:a547be3ce1ca16f0:571a4f20815f5b9c Session Type:HIVESERVER2 Sql Statement:\n                 SELECT \n\t                 COUNT(DISTINCT SSN) AS  ENROLLMENTALERTCOUNT\n\t                 FROM PLANFOCUS.ENROLLMENTS\n\t                 WHERE PARTITION_ID=1 AND (PLAN_NUMBER in ('100320','100321','100322','100323','100325','100326','100327')) \n\t                 AND CLIENT_NUMBER='008353'\n\t                 AND PLAN_LEVEL_ENROLLMENT_STATUS = 'Completed Enrollment'\n\t                 AND ENROLLMENT_TYPE_NAME IN ('Online', 'Paper', 'Phone')                \n\t                 AND (ENROLLMENT_DATE BETWEEN '20160312' AND '20160318') \n                 AND SSN NOT IN ('777777777','999999999');\n                \t\n        Start Time:2016-03-29 13:47:43.782492000 User:] InfoStringsDisplayOrder:[Session ID Session Type HiveServer2 Protocol Version Start Time End Time Query Type Query State Query Status Impala Version User Connected User Delegated User Network Address Default Db Sql Statement Coordinator Plan Estimated Per-Host Mem Estimated Per-Host VCores Request Pool ExecSummary] ChildCountersMap:map[] EventSequences:[TEventSequence({Name:Planner Timeline Timestamps:[1119874 1180597 1683352 1966156 2180420 2714679] Labels:[Analysis finished Equivalence classes computed Single node plan created Distributed plan created Lineage info computed Planning finished]}) TEventSequence({Name:Query Timeline Timestamps:[33302 3760503 135077672 459451676 794643813 795729316 796745844] Labels:[Start execution Planning finished Ready to start remote fragments Remote fragments started Rows available First row fetched Unregister query]})] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:ImpalaServer NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:ClientFetchWaitTimer Unit:TIME_NS Value:1887382}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:RowMaterializationTimer Unit:TIME_NS Value:2575}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[ClientFetchWaitTimer RowMaterializationTimer]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Execution Profile 4c4d52afea4a40a1:802034563d1cfc93 NumChildren:5 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:FinalizationTimer Unit:TIME_NS Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:790691436})] Metadata:-1 Indent:true InfoStrings:map[Fragment start latencies:count: 2, last: 0.162958ns, min: 0.160986ns, max: 0.162958ns, mean: 0.161972ns, stddev: 0.000986ns Per Node Peak Memory Usage:denatb31bda03.test.tiaa-cref.org:22000(15.35 MB) denatb31bda01.test.tiaa-cref.org:22000(0) ] InfoStringsDisplayOrder:[Fragment start latencies Per Node Peak Memory Usage] ChildCountersMap:map[:[FinalizationTimer]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Coordinator Fragment F02 NumChildren:3 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageThreadTokens Unit:DOUBLE_VALUE Value:4607182418800017408}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:28672}) TCounter({Name:PerHostPeakMemUsage Unit:BYTES Value:0}) TCounter({Name:PrepareTime Unit:TIME_NS Value:130790792}) TCounter({Name:RowsProduced Unit:UNIT Value:1}) TCounter({Name:TotalCpuTime Unit:TIME_NS Value:570850018}) TCounter({Name:TotalNetworkReceiveTime Unit:TIME_NS Value:220903743}) TCounter({Name:TotalNetworkSendTime Unit:TIME_NS Value:0}) TCounter({Name:TotalStorageWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:351939320})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[AverageThreadTokens PeakMemoryUsage PerHostPeakMemUsage PrepareTime RowsProduced TotalCpuTime TotalNetworkReceiveTime TotalNetworkSendTime TotalStorageWaitTime]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:MemoryUsage Unit:BYTES PeriodMs:500 Values:[0 12288] StartIndex:<nil>}) TTimeSeriesCounter({Name:ThreadUsage Unit:UNIT PeriodMs:500 Values:[1] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:BlockMgr NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BlockWritesOutstanding Unit:UNIT Value:0}) TCounter({Name:BlocksCreated Unit:UNIT Value:0}) TCounter({Name:BlocksRecycled Unit:UNIT Value:0}) TCounter({Name:BufferedPins Unit:UNIT Value:0}) TCounter({Name:BytesWritten Unit:BYTES Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:MaxBlockSize Unit:BYTES Value:8388608}) TCounter({Name:MemoryLimit Unit:BYTES Value:61847531520}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:0}) TCounter({Name:TotalBufferWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalEncryptionTime Unit:TIME_NS Value:0}) TCounter({Name:TotalIntegrityCheckTime Unit:TIME_NS Value:0}) TCounter({Name:TotalReadBlockTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BlockWritesOutstanding BlocksCreated BlocksRecycled BufferedPins BytesWritten MaxBlockSize MemoryLimit PeakMemoryUsage TotalBufferWaitTime TotalEncryptionTime TotalIntegrityCheckTime TotalReadBlockTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:CodeGen NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:CodegenTime Unit:TIME_NS Value:346643}) TCounter({Name:CompileTime Unit:TIME_NS Value:4276243}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LoadTime Unit:TIME_NS Value:71650}) TCounter({Name:ModuleFileSize Unit:BYTES Value:2309684}) TCounter({Name:OptimizationTime Unit:TIME_NS Value:109700624}) TCounter({Name:PrepareTime Unit:TIME_NS Value:129321802}) TCounter({Name:TotalTime Unit:TIME_NS Value:244441216})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[CodegenTime CompileTime LoadTime ModuleFileSize OptimizationTime PrepareTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=6) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:1269}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:16384}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:1}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:2}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:351746358})] Metadata:6 Indent:true InfoStrings:map[ExecOption:Codegen Enabled] InfoStringsDisplayOrder:[ExecOption] ChildCountersMap:map[:[BuildTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:EXCHANGE_NODE (id=5) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesReceived Unit:BYTES Value:16}) TCounter({Name:ConvertRowBatchTime Unit:TIME_NS Value:763}) TCounter({Name:DeserializeRowBatchTimer Unit:TIME_NS Value:7816}) TCounter({Name:FirstBatchArrivalWaitTime Unit:TIME_NS Value:220805423}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:220900377}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:1}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:4}) TCounter({Name:SendersBlockedTimer Unit:TIME_NS Value:0}) TCounter({Name:SendersBlockedTotalTimer(*) Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:220908627})] Metadata:5 Indent:false InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesReceived ConvertRowBatchTime DeserializeRowBatchTimer FirstBatchArrivalWaitTime PeakMemoryUsage RowsReturned RowsReturnedRate SendersBlockedTimer SendersBlockedTotalTimer(*)]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:BytesReceived Unit:BYTES PeriodMs:500 Values:[0] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Averaged Fragment F01 NumChildren:4 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageThreadTokens Unit:DOUBLE_VALUE Value:4607182418800017408}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:3313664}) TCounter({Name:PerHostPeakMemUsage Unit:BYTES Value:16096168}) TCounter({Name:PrepareTime Unit:TIME_NS Value:159843723}) TCounter({Name:RowsProduced Unit:UNIT Value:1}) TCounter({Name:TotalCpuTime Unit:TIME_NS Value:340056217}) TCounter({Name:TotalNetworkReceiveTime Unit:TIME_NS Value:318797081}) TCounter({Name:TotalNetworkSendTime Unit:TIME_NS Value:150781}) TCounter({Name:TotalStorageWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:479335847})] Metadata:-1 Indent:true InfoStrings:map[completion times:min:499.138ms  max:499.138ms  mean: 499.138229.138.229000ms  stddev:0.000000ns execution rates:min:0.00 /sec  max:0.00 /sec  mean:0.00 /sec  stddev:0.00 /sec num instances:1 split sizes: min: 0, max: 0, avg: 0, stddev: 0] InfoStringsDisplayOrder:[split sizes completion times execution rates num instances] ChildCountersMap:map[:[AverageThreadTokens PeakMemoryUsage PerHostPeakMemUsage PrepareTime RowsProduced TotalCpuTime TotalNetworkReceiveTime TotalNetworkSendTime TotalStorageWaitTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:BlockMgr NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BlockWritesOutstanding Unit:UNIT Value:0}) TCounter({Name:BlocksCreated Unit:UNIT Value:96}) TCounter({Name:BlocksRecycled Unit:UNIT Value:0}) TCounter({Name:BufferedPins Unit:UNIT Value:0}) TCounter({Name:BytesWritten Unit:BYTES Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:MaxBlockSize Unit:BYTES Value:8388608}) TCounter({Name:MemoryLimit Unit:BYTES Value:61847531520}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:262144}) TCounter({Name:TotalBufferWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalEncryptionTime Unit:TIME_NS Value:0}) TCounter({Name:TotalIntegrityCheckTime Unit:TIME_NS Value:0}) TCounter({Name:TotalReadBlockTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BlockWritesOutstanding BlocksCreated BlocksRecycled BufferedPins BytesWritten MaxBlockSize MemoryLimit PeakMemoryUsage TotalBufferWaitTime TotalEncryptionTime TotalIntegrityCheckTime TotalReadBlockTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:CodeGen NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:CodegenTime Unit:TIME_NS Value:2151563}) TCounter({Name:CompileTime Unit:TIME_NS Value:24275838}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LoadTime Unit:TIME_NS Value:101706}) TCounter({Name:ModuleFileSize Unit:BYTES Value:2309684}) TCounter({Name:OptimizationTime Unit:TIME_NS Value:154665887}) TCounter({Name:PrepareTime Unit:TIME_NS Value:155962605}) TCounter({Name:TotalTime Unit:TIME_NS Value:336292146})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[CodegenTime CompileTime LoadTime ModuleFileSize OptimizationTime PrepareTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:DataStreamSender (dst_id=5) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesSent Unit:BYTES Value:16}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:NetworkThroughput(*) Unit:BYTES_PER_SECOND Value:135058}) TCounter({Name:OverallThroughput Unit:BYTES_PER_SECOND Value:738995}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:16384}) TCounter({Name:SerializeBatchTime Unit:TIME_NS Value:5225}) TCounter({Name:ThriftTransmitTime(*) Unit:TIME_NS Value:118467}) TCounter({Name:TotalTime Unit:TIME_NS Value:21651}) TCounter({Name:UncompressedRowBatchSize Unit:BYTES Value:16})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesSent NetworkThroughput(*) OverallThroughput PeakMemoryUsage SerializeBatchTime ThriftTransmitTime(*) UncompressedRowBatchSize]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=2) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:971}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:12288}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:1}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:2}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:478897299})] Metadata:2 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BuildTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=4) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:1624}) TCounter({Name:GetNewBlockTime Unit:TIME_NS Value:119296}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:16}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:3284992}) TCounter({Name:PinTime Unit:TIME_NS Value:0}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:321252376}) TCounter({Name:UnpinTime Unit:TIME_NS Value:579})] Metadata:4 Indent:false InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BuildTime GetNewBlockTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage PinTime RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions UnpinTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:EXCHANGE_NODE (id=3) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesReceived Unit:BYTES Value:0}) TCounter({Name:ConvertRowBatchTime Unit:TIME_NS Value:664}) TCounter({Name:DeserializeRowBatchTimer Unit:TIME_NS Value:0}) TCounter({Name:FirstBatchArrivalWaitTime Unit:TIME_NS Value:318794492}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SendersBlockedTimer Unit:TIME_NS Value:0}) TCounter({Name:SendersBlockedTotalTimer(*) Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:318799539})] Metadata:3 Indent:false InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesReceived ConvertRowBatchTime DeserializeRowBatchTimer FirstBatchArrivalWaitTime PeakMemoryUsage RowsReturned RowsReturnedRate SendersBlockedTimer SendersBlockedTotalTimer(*)]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Averaged Fragment F00 NumChildren:3 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageThreadTokens Unit:DOUBLE_VALUE Value:4607182418800017408}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:12790696}) TCounter({Name:PerHostPeakMemUsage Unit:BYTES Value:16096168}) TCounter({Name:PrepareTime Unit:TIME_NS Value:161656034}) TCounter({Name:RowsProduced Unit:UNIT Value:0}) TCounter({Name:TotalCpuTime Unit:TIME_NS Value:573575144}) TCounter({Name:TotalNetworkReceiveTime Unit:TIME_NS Value:0}) TCounter({Name:TotalNetworkSendTime Unit:TIME_NS Value:197}) TCounter({Name:TotalStorageWaitTime Unit:TIME_NS Value:13059169}) TCounter({Name:TotalTime Unit:TIME_NS Value:252201913})] Metadata:-1 Indent:true InfoStrings:map[completion times:min:335.469ms  max:335.469ms  mean: 335.469722.469.722000ms  stddev:0.000000ns execution rates:min:119.93 MB/sec  max:119.93 MB/sec  mean:119.93 MB/sec  stddev:0.00 /sec num instances:1 split sizes: min: 40.23 MB, max: 40.23 MB, avg: 40.23 MB, stddev: 0] InfoStringsDisplayOrder:[split sizes completion times execution rates num instances] ChildCountersMap:map[:[AverageThreadTokens PeakMemoryUsage PerHostPeakMemUsage PrepareTime RowsProduced TotalCpuTime TotalNetworkReceiveTime TotalNetworkSendTime TotalStorageWaitTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:CodeGen NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:CodegenTime Unit:TIME_NS Value:1807535}) TCounter({Name:CompileTime Unit:TIME_NS Value:47006275}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LoadTime Unit:TIME_NS Value:85832}) TCounter({Name:ModuleFileSize Unit:BYTES Value:2309684}) TCounter({Name:OptimizationTime Unit:TIME_NS Value:197445324}) TCounter({Name:PrepareTime Unit:TIME_NS Value:156205959}) TCounter({Name:TotalTime Unit:TIME_NS Value:402263979})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[CodegenTime CompileTime LoadTime ModuleFileSize OptimizationTime PrepareTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:DataStreamSender (dst_id=3) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesSent Unit:BYTES Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:NetworkThroughput(*) Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:OverallThroughput Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:5456}) TCounter({Name:SerializeBatchTime Unit:TIME_NS Value:0}) TCounter({Name:ThriftTransmitTime(*) Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:15912}) TCounter({Name:UncompressedRowBatchSize Unit:BYTES Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesSent NetworkThroughput(*) OverallThroughput PeakMemoryUsage SerializeBatchTime ThriftTransmitTime(*) UncompressedRowBatchSize]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=1) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:122026}) TCounter({Name:GetNewBlockTime Unit:TIME_NS Value:118352}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:16}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:9909848}) TCounter({Name:PinTime Unit:TIME_NS Value:0}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:251736002}) TCounter({Name:UnpinTime Unit:TIME_NS Value:589})] Metadata:1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BuildTime GetNewBlockTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage PinTime RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions UnpinTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:HDFS_SCAN_NODE (id=0) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageHdfsReadThreadConcurrency Unit:DOUBLE_VALUE Value:0}) TCounter({Name:AverageScannerThreadConcurrency Unit:DOUBLE_VALUE Value:0}) TCounter({Name:BytesRead Unit:BYTES Value:2620436}) TCounter({Name:BytesReadDataNodeCache Unit:BYTES Value:0}) TCounter({Name:BytesReadLocal Unit:BYTES Value:2620436}) TCounter({Name:BytesReadRemoteUnexpected Unit:BYTES Value:0}) TCounter({Name:BytesReadShortCircuit Unit:BYTES Value:2620436}) TCounter({Name:DecompressionTime Unit:TIME_NS Value:6857012}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:MaterializeTupleTime(*) Unit:TIME_NS Value:67107564}) TCounter({Name:MaxCompressedTextFileLength Unit:BYTES Value:0}) TCounter({Name:NumColumns Unit:UNIT Value:6}) TCounter({Name:NumDisksAccessed Unit:UNIT Value:1}) TCounter({Name:NumScannerThreadsStarted Unit:UNIT Value:1}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:9492056}) TCounter({Name:PerReadThreadRawHdfsThroughput Unit:BYTES_PER_SECOND Value:1718151943}) TCounter({Name:RemoteScanRanges Unit:UNIT Value:0}) TCounter({Name:RowsRead Unit:UNIT Value:378695}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:ScanRangesComplete Unit:UNIT Value:1}) TCounter({Name:ScannerThreadsInvoluntaryContextSwitches Unit:UNIT Value:0}) TCounter({Name:ScannerThreadsSysTime Unit:TIME_NS Value:0}) TCounter({Name:ScannerThreadsTotalWallClockTime Unit:TIME_NS Value:89506826}) TCounter({Name:ScannerThreadsUserTime Unit:TIME_NS Value:74988000}) TCounter({Name:ScannerThreadsVoluntaryContextSwitches Unit:UNIT Value:13}) TCounter({Name:TotalRawHdfsReadTime(*) Unit:TIME_NS Value:1525148}) TCounter({Name:TotalReadThroughput Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:92478559})] Metadata:0 Indent:false InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[AverageHdfsReadThreadConcurrency AverageScannerThreadConcurrency BytesRead BytesReadDataNodeCache BytesReadLocal BytesReadRemoteUnexpected BytesReadShortCircuit DecompressionTime MaxCompressedTextFileLength NumColumns NumDisksAccessed NumScannerThreadsStarted PeakMemoryUsage PerReadThreadRawHdfsThroughput RemoteScanRanges RowsRead RowsReturned RowsReturnedRate ScanRangesComplete ScannerThreadsInvoluntaryContextSwitches ScannerThreadsTotalWallClockTime ScannerThreadsVoluntaryContextSwitches TotalRawHdfsReadTime(*) TotalReadThroughput] ScannerThreadsTotalWallClockTime:[MaterializeTupleTime(*) ScannerThreadsSysTime ScannerThreadsUserTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Fragment F01 NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Instance 4c4d52afea4a40a1:802034563d1cfc95 (host=denatb31bda03.test.tiaa-cref.org:22000) NumChildren:4 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageThreadTokens Unit:DOUBLE_VALUE Value:4607182418800017408}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:3313664}) TCounter({Name:PerHostPeakMemUsage Unit:BYTES Value:16096168}) TCounter({Name:PrepareTime Unit:TIME_NS Value:159843723}) TCounter({Name:RowsProduced Unit:UNIT Value:1}) TCounter({Name:TotalCpuTime Unit:TIME_NS Value:340056217}) TCounter({Name:TotalNetworkReceiveTime Unit:TIME_NS Value:318797081}) TCounter({Name:TotalNetworkSendTime Unit:TIME_NS Value:150781}) TCounter({Name:TotalStorageWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:479335847})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[AverageThreadTokens PeakMemoryUsage PerHostPeakMemUsage PrepareTime RowsProduced TotalCpuTime TotalNetworkReceiveTime TotalNetworkSendTime TotalStorageWaitTime]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:MemoryUsage Unit:BYTES PeriodMs:500 Values:[3305472] StartIndex:<nil>}) TTimeSeriesCounter({Name:ThreadUsage Unit:UNIT PeriodMs:500 Values:[1] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:BlockMgr NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BlockWritesOutstanding Unit:UNIT Value:0}) TCounter({Name:BlocksCreated Unit:UNIT Value:96}) TCounter({Name:BlocksRecycled Unit:UNIT Value:0}) TCounter({Name:BufferedPins Unit:UNIT Value:0}) TCounter({Name:BytesWritten Unit:BYTES Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:MaxBlockSize Unit:BYTES Value:8388608}) TCounter({Name:MemoryLimit Unit:BYTES Value:61847531520}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:262144}) TCounter({Name:TotalBufferWaitTime Unit:TIME_NS Value:0}) TCounter({Name:TotalEncryptionTime Unit:TIME_NS Value:0}) TCounter({Name:TotalIntegrityCheckTime Unit:TIME_NS Value:0}) TCounter({Name:TotalReadBlockTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BlockWritesOutstanding BlocksCreated BlocksRecycled BufferedPins BytesWritten MaxBlockSize MemoryLimit PeakMemoryUsage TotalBufferWaitTime TotalEncryptionTime TotalIntegrityCheckTime TotalReadBlockTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:CodeGen NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:CodegenTime Unit:TIME_NS Value:2151563}) TCounter({Name:CompileTime Unit:TIME_NS Value:24275838}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LoadTime Unit:TIME_NS Value:101706}) TCounter({Name:ModuleFileSize Unit:BYTES Value:2309684}) TCounter({Name:OptimizationTime Unit:TIME_NS Value:154665887}) TCounter({Name:PrepareTime Unit:TIME_NS Value:155962605}) TCounter({Name:TotalTime Unit:TIME_NS Value:336292146})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[CodegenTime CompileTime LoadTime ModuleFileSize OptimizationTime PrepareTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:DataStreamSender (dst_id=5) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesSent Unit:BYTES Value:16}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:NetworkThroughput(*) Unit:BYTES_PER_SECOND Value:135058}) TCounter({Name:OverallThroughput Unit:BYTES_PER_SECOND Value:738995}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:16384}) TCounter({Name:SerializeBatchTime Unit:TIME_NS Value:5225}) TCounter({Name:ThriftTransmitTime(*) Unit:TIME_NS Value:118467}) TCounter({Name:TotalTime Unit:TIME_NS Value:21651}) TCounter({Name:UncompressedRowBatchSize Unit:BYTES Value:16})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesSent NetworkThroughput(*) OverallThroughput PeakMemoryUsage SerializeBatchTime ThriftTransmitTime(*) UncompressedRowBatchSize]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=2) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:971}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:12288}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:1}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:2}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:478897299})] Metadata:2 Indent:true InfoStrings:map[ExecOption:Codegen Enabled] InfoStringsDisplayOrder:[ExecOption] ChildCountersMap:map[:[BuildTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=4) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:1624}) TCounter({Name:GetNewBlockTime Unit:TIME_NS Value:119296}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:16}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:3284992}) TCounter({Name:PinTime Unit:TIME_NS Value:0}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:321252376}) TCounter({Name:UnpinTime Unit:TIME_NS Value:579})] Metadata:4 Indent:false InfoStrings:map[ExecOption:Codegen Enabled] InfoStringsDisplayOrder:[ExecOption] ChildCountersMap:map[:[BuildTime GetNewBlockTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage PinTime RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions UnpinTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:EXCHANGE_NODE (id=3) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesReceived Unit:BYTES Value:0}) TCounter({Name:ConvertRowBatchTime Unit:TIME_NS Value:664}) TCounter({Name:DeserializeRowBatchTimer Unit:TIME_NS Value:0}) TCounter({Name:FirstBatchArrivalWaitTime Unit:TIME_NS Value:318794492}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:318794955}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SendersBlockedTimer Unit:TIME_NS Value:0}) TCounter({Name:SendersBlockedTotalTimer(*) Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:318799539})] Metadata:3 Indent:false InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesReceived ConvertRowBatchTime DeserializeRowBatchTimer FirstBatchArrivalWaitTime PeakMemoryUsage RowsReturned RowsReturnedRate SendersBlockedTimer SendersBlockedTotalTimer(*)]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:BytesReceived Unit:BYTES PeriodMs:500 Values:[0] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Fragment F00 NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:Instance 4c4d52afea4a40a1:802034563d1cfc96 (host=denatb31bda03.test.tiaa-cref.org:22000) NumChildren:3 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageThreadTokens Unit:DOUBLE_VALUE Value:4607182418800017408}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:12790696}) TCounter({Name:PerHostPeakMemUsage Unit:BYTES Value:16096168}) TCounter({Name:PrepareTime Unit:TIME_NS Value:161656034}) TCounter({Name:RowsProduced Unit:UNIT Value:0}) TCounter({Name:TotalCpuTime Unit:TIME_NS Value:573575144}) TCounter({Name:TotalNetworkReceiveTime Unit:TIME_NS Value:0}) TCounter({Name:TotalNetworkSendTime Unit:TIME_NS Value:197}) TCounter({Name:TotalStorageWaitTime Unit:TIME_NS Value:13059169}) TCounter({Name:TotalTime Unit:TIME_NS Value:252201913})] Metadata:-1 Indent:true InfoStrings:map[Hdfs split stats (<volume id>:<# splits>/<split lengths>):1:1/40.23 MB ] InfoStringsDisplayOrder:[Hdfs split stats (<volume id>:<# splits>/<split lengths>)] ChildCountersMap:map[:[AverageThreadTokens PeakMemoryUsage PerHostPeakMemUsage PrepareTime RowsProduced TotalCpuTime TotalNetworkReceiveTime TotalNetworkSendTime TotalStorageWaitTime]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:MemoryUsage Unit:BYTES PeriodMs:500 Values:[3290448] StartIndex:<nil>}) TTimeSeriesCounter({Name:ThreadUsage Unit:UNIT PeriodMs:500 Values:[1] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:CodeGen NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:CodegenTime Unit:TIME_NS Value:1807535}) TCounter({Name:CompileTime Unit:TIME_NS Value:47006275}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LoadTime Unit:TIME_NS Value:85832}) TCounter({Name:ModuleFileSize Unit:BYTES Value:2309684}) TCounter({Name:OptimizationTime Unit:TIME_NS Value:197445324}) TCounter({Name:PrepareTime Unit:TIME_NS Value:156205959}) TCounter({Name:TotalTime Unit:TIME_NS Value:402263979})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[CodegenTime CompileTime LoadTime ModuleFileSize OptimizationTime PrepareTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:DataStreamSender (dst_id=3) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BytesSent Unit:BYTES Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:NetworkThroughput(*) Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:OverallThroughput Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:5456}) TCounter({Name:SerializeBatchTime Unit:TIME_NS Value:0}) TCounter({Name:ThriftTransmitTime(*) Unit:TIME_NS Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:15912}) TCounter({Name:UncompressedRowBatchSize Unit:BYTES Value:0})] Metadata:-1 Indent:true InfoStrings:map[] InfoStringsDisplayOrder:[] ChildCountersMap:map[:[BytesSent NetworkThroughput(*) OverallThroughput PeakMemoryUsage SerializeBatchTime ThriftTransmitTime(*) UncompressedRowBatchSize]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:AGGREGATION_NODE (id=1) NumChildren:1 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:BuildTime Unit:TIME_NS Value:122026}) TCounter({Name:GetNewBlockTime Unit:TIME_NS Value:118352}) TCounter({Name:GetResultsTime Unit:TIME_NS Value:0}) TCounter({Name:HashBuckets Unit:UNIT Value:0}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:LargestPartitionPercent Unit:UNIT Value:0}) TCounter({Name:MaxPartitionLevel Unit:UNIT Value:0}) TCounter({Name:NumRepartitions Unit:UNIT Value:0}) TCounter({Name:PartitionsCreated Unit:UNIT Value:16}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:9909848}) TCounter({Name:PinTime Unit:TIME_NS Value:0}) TCounter({Name:RowsRepartitioned Unit:UNIT Value:0}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:SpilledPartitions Unit:UNIT Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:251736002}) TCounter({Name:UnpinTime Unit:TIME_NS Value:589})] Metadata:1 Indent:true InfoStrings:map[ExecOption:Codegen Enabled] InfoStringsDisplayOrder:[ExecOption] ChildCountersMap:map[:[BuildTime GetNewBlockTime GetResultsTime HashBuckets LargestPartitionPercent MaxPartitionLevel NumRepartitions PartitionsCreated PeakMemoryUsage PinTime RowsRepartitioned RowsReturned RowsReturnedRate SpilledPartitions UnpinTime]] EventSequences:[] TimeSeriesCounters:[] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>}) TRuntimeProfileNode({Name:HDFS_SCAN_NODE (id=0) NumChildren:0 Counters:[TCounter({Name:AsyncTotalTime Unit:TIME_NS Value:0}) TCounter({Name:AverageHdfsReadThreadConcurrency Unit:DOUBLE_VALUE Value:0}) TCounter({Name:AverageScannerThreadConcurrency Unit:DOUBLE_VALUE Value:0}) TCounter({Name:BytesRead Unit:BYTES Value:2620436}) TCounter({Name:BytesReadDataNodeCache Unit:BYTES Value:0}) TCounter({Name:BytesReadLocal Unit:BYTES Value:2620436}) TCounter({Name:BytesReadRemoteUnexpected Unit:BYTES Value:0}) TCounter({Name:BytesReadShortCircuit Unit:BYTES Value:2620436}) TCounter({Name:DecompressionTime Unit:TIME_NS Value:6857012}) TCounter({Name:InactiveTotalTime Unit:TIME_NS Value:0}) TCounter({Name:MaterializeTupleTime(*) Unit:TIME_NS Value:67107564}) TCounter({Name:MaxCompressedTextFileLength Unit:BYTES Value:0}) TCounter({Name:NumColumns Unit:UNIT Value:6}) TCounter({Name:NumDisksAccessed Unit:UNIT Value:1}) TCounter({Name:NumScannerThreadsStarted Unit:UNIT Value:1}) TCounter({Name:PeakMemoryUsage Unit:BYTES Value:9492056}) TCounter({Name:PerReadThreadRawHdfsThroughput Unit:BYTES_PER_SECOND Value:1718151943}) TCounter({Name:RemoteScanRanges Unit:UNIT Value:0}) TCounter({Name:RowsRead Unit:UNIT Value:378695}) TCounter({Name:RowsReturned Unit:UNIT Value:0}) TCounter({Name:RowsReturnedRate Unit:UNIT_PER_SECOND Value:0}) TCounter({Name:ScanRangesComplete Unit:UNIT Value:1}) TCounter({Name:ScannerThreadsInvoluntaryContextSwitches Unit:UNIT Value:0}) TCounter({Name:ScannerThreadsSysTime Unit:TIME_NS Value:0}) TCounter({Name:ScannerThreadsTotalWallClockTime Unit:TIME_NS Value:89506826}) TCounter({Name:ScannerThreadsUserTime Unit:TIME_NS Value:74988000}) TCounter({Name:ScannerThreadsVoluntaryContextSwitches Unit:UNIT Value:13}) TCounter({Name:TotalRawHdfsReadTime(*) Unit:TIME_NS Value:1525148}) TCounter({Name:TotalReadThroughput Unit:BYTES_PER_SECOND Value:0}) TCounter({Name:TotalTime Unit:TIME_NS Value:92478559})] Metadata:0 Indent:false InfoStrings:map[ExecOption:Codegen enabled: 0 out of 1 File Formats:PARQUET/SNAPPY:6  Hdfs Read Thread Concurrency Bucket:0:0% 1:0% 2:0% 3:0% 4:0% 5:0% 6:0% 7:0% 8:0% 9:0% 10:0% 11:0% 12:0% 13:0% 14:0% 15:0%  Hdfs split stats (<volume id>:<# splits>/<split lengths>):1:1/40.23 MB ] InfoStringsDisplayOrder:[Hdfs split stats (<volume id>:<# splits>/<split lengths>) Hdfs Read Thread Concurrency Bucket File Formats ExecOption] ChildCountersMap:map[:[AverageHdfsReadThreadConcurrency AverageScannerThreadConcurrency BytesRead BytesReadDataNodeCache BytesReadLocal BytesReadRemoteUnexpected BytesReadShortCircuit DecompressionTime MaxCompressedTextFileLength NumColumns NumDisksAccessed NumScannerThreadsStarted PeakMemoryUsage PerReadThreadRawHdfsThroughput RemoteScanRanges RowsRead RowsReturned RowsReturnedRate ScanRangesComplete ScannerThreadsInvoluntaryContextSwitches ScannerThreadsTotalWallClockTime ScannerThreadsVoluntaryContextSwitches TotalRawHdfsReadTime(*) TotalReadThroughput] ScannerThreadsTotalWallClockTime:[MaterializeTupleTime(*) ScannerThreadsSysTime ScannerThreadsUserTime]] EventSequences:[] TimeSeriesCounters:[TTimeSeriesCounter({Name:BytesRead Unit:BYTES PeriodMs:500 Values:[0] StartIndex:<nil>})] SummaryStatsCounters:[] NodeMetadata:<nil> Aggregated:<nil>})] ExecSummary:<nil> ProfileVersion:<nil>})"
	queryId = "4c4d52afea4a40a1:802034563d1cfc93"
)

var timestamp = strconv.Itoa(time.Now().Year()) + "-08-28T10:36:22+08:00"
var impalaLogCases = map[string]struct {
	cfg      *conf.C
	in       mapstr.M
	want     mapstr.M
	wantTime time.Time
	wantErr  bool
}{
	"impala_log_default": {
		cfg: conf.MustNewConfigFrom(mapstr.M{}),
		in: mapstr.M{
			"message": rawLine,
		},
		want: mapstr.M{
			"impala_log": map[string]interface{}{
				"timestamp":   timestamp,
				"application": "Impala",
				"component":   "statestore",
				"host":        impala.GetLocalIP(),
				"msg":         "Subscriber 'impalad@e2de5bdh002:6001' registered (registration id: c24233er53agg:c89gg6fds880)",
				"log_level":   "INFO",
				"thread_name": "25339",
				"extend": map[string]interface{}{
					"location": "statestore.cc:282",
				},
			},
			"message": rawLine,
		},
	},
}

func TestParse(t *testing.T) {
	values, _ := parseMap(rawLine)
	for k, v := range values {
		fmt.Printf("%+15s: %s\n", k, v)
	}
}

func TestTime(t *testing.T) {
	layout := "2006-01-02 15:04:05"
	str := "2022-08-28 10:36:22"
	tt, err := time.ParseInLocation(layout, str, time.Local)

	if err != nil {
		fmt.Println(err)
	}
	fmt.Println(tt)
	fmt.Println(tt.Format(layout))
}
func TestImpalaLog(t *testing.T) {
	for name, tc := range impalaLogCases {
		tc := tc
		t.Run(name, func(t *testing.T) {
			t.Parallel()

			p, err := New(tc.cfg)
			if err != nil {
				panic(err)
			}
			event := &beat.Event{
				Fields: tc.in,
			}

			got, gotErr := p.Run(event)
			if tc.wantErr {
				assert.Error(t, gotErr)
			} else {
				assert.NoError(t, gotErr)
			}

			assert.Equal(t, tc.want, got.Fields)
		})
	}
}

func BenchmarkImpalaLog(b *testing.B) {
	for name, bc := range impalaLogCases {
		bc := bc
		b.Run(name, func(b *testing.B) {
			b.ReportAllocs()
			for i := 0; i < b.N; i++ {

				p, _ := New(bc.cfg)
				event := &beat.Event{
					Fields: bc.in,
				}

				_, _ = p.Run(event)
			}
		})
	}
}

func TestAppendStringField(t *testing.T) {
	tests := map[string]struct {
		inMap   mapstr.M
		inField string
		inValue string
		want    mapstr.M
	}{
		"nil": {
			inMap:   mapstr.M{},
			inField: "error",
			inValue: "foo",
			want: mapstr.M{
				"error": "foo",
			},
		},
		"string": {
			inMap: mapstr.M{
				"error": "foo",
			},
			inField: "error",
			inValue: "bar",
			want: mapstr.M{
				"error": []string{"foo", "bar"},
			},
		},
		"string-slice": {
			inMap: mapstr.M{
				"error": []string{"foo", "bar"},
			},
			inField: "error",
			inValue: "some value",
			want: mapstr.M{
				"error": []string{"foo", "bar", "some value"},
			},
		},
		"interface-slice": {
			inMap: mapstr.M{
				"error": []interface{}{"foo", "bar"},
			},
			inField: "error",
			inValue: "some value",
			want: mapstr.M{
				"error": []interface{}{"foo", "bar", "some value"},
			},
		},
	}

	for name, tc := range tests {
		tc := tc
		t.Run(name, func(t *testing.T) {
			t.Parallel()
			appendStringField(tc.inMap, tc.inField, tc.inValue)

			assert.Equal(t, tc.want, tc.inMap)
		})
	}
}
